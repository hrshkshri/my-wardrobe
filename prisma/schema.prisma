// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  USER
  STYLIST
}

enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
  ALL_SEASON
}

enum ItemStatus {
  AVAILABLE
  IN_LAUNDRY
  IN_REPAIR
  DONATED
  SOLD
}

enum SharePermission {
  VIEW_ONLY
  SUGGEST
  FULL_ACCESS
}

enum RequestStatus {
  PENDING
  MATCHED
  COMPLETED
  CANCELLED
  EXPIRED
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum TransactionType {
  EARNING
  WITHDRAWAL
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum NotificationType {
  STYLING_REQUEST
  STYLIST_MATCHED
  NEW_MESSAGE
  SESSION_ENDED
  PAYMENT_RECEIVED
  REVIEW_RECEIVED
  WARDROBE_SHARED
  OUTFIT_SUGGESTION
}

enum RequestTimeline {
  URGENT
  WITHIN_WEEK
  FLEXIBLE
}

enum RequestType {
  IMMEDIATE  // Race mode - first stylist to accept
  SCHEDULED  // Appointment-based - book for specific time
}

// ==================== USER MODELS ====================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String?
  name              String
  phone             String?
  bio               String?
  avatar            String?
  role              UserRole  @default(USER)
  emailVerified     Boolean   @default(false)
  emailVerificationToken String?
  passwordResetToken String?
  passwordResetExpires DateTime?
  googleId          String?   @unique
  appleId           String?   @unique
  freeSessions      Int       @default(3)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  wardrobes         Wardrobe[]
  outfits           Outfit[]
  stylistProfile    StylistProfile?
  stylingRequests   StylingRequest[]
  userSessions      StylingSession[] @relation("UserSessions")
  stylistSessions   StylingSession[] @relation("StylistSessions")
  sentMessages      Message[]
  receivedReviews   Review[] @relation("ReviewsForStylist")
  givenReviews      Review[] @relation("ReviewsFromUser")
  payments          Payment[]
  notifications     Notification[]
  sharedWardrobes   WardrobeShare[] @relation("WardrobeOwner")
  accessibleWardrobes WardrobeShare[] @relation("SharedWithUser")
  sharedOutfits     OutfitShare[] @relation("OutfitOwner")
  accessibleOutfits OutfitShare[] @relation("SharedWithUser_Outfit")
  outfitSuggestions OutfitSuggestion[]
  fcmTokens         FCMToken[]

  @@index([email])
  @@index([googleId])
  @@index([appleId])
}

model StylistProfile {
  id                String    @id @default(uuid())
  userId            String    @unique
  bio               String
  yearsOfExperience Int
  pricePerSession   Float
  languages         String[]
  expertise         String[] // Tags like "Bridal", "Party", "Streetwear"
  portfolioImages   String[]
  isAvailable       Boolean   @default(true)
  isVerified        Boolean   @default(true) // Instant verification (no admin approval)
  totalSessions     Int       @default(0)
  totalEarnings     Float     @default(0)
  averageRating     Float     @default(0)
  totalReviews      Int       @default(0)
  walletBalance     Float     @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  user              User @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  withdrawals       Withdrawal[]

  @@index([userId])
  @@index([isAvailable])
  @@index([isVerified])
}

model FCMToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  deviceId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ==================== WARDROBE MODELS ====================

model Wardrobe {
  id          String    @id @default(uuid())
  userId      String
  name        String
  location    String?
  description String?
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  categories  Category[]
  items       ClothingItem[]
  shares      WardrobeShare[]
  suggestions OutfitSuggestion[]

  @@index([userId])
  @@index([userId, isDefault])
}

model Category {
  id          String    @id @default(uuid())
  wardrobeId  String
  name        String
  parentId    String?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  wardrobe    Wardrobe @relation(fields: [wardrobeId], references: [id], onDelete: Cascade)
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Category[] @relation("CategoryHierarchy")
  items       ClothingItem[]

  @@index([wardrobeId])
  @@index([parentId])
}

model ClothingItem {
  id            String    @id @default(uuid())
  wardrobeId    String
  categoryId    String?
  name          String
  itemType      String
  color         String?
  season        Season    @default(ALL_SEASON)
  brand         String?
  notes         String?
  purchaseDate  DateTime?
  price         Float?
  status        ItemStatus @default(AVAILABLE)
  isPrivate     Boolean   @default(false) // Private items hidden when sharing wardrobe
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  wardrobe      Wardrobe @relation(fields: [wardrobeId], references: [id], onDelete: Cascade)
  category      Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  images        ClothingImage[]
  outfitItems   OutfitItem[]

  @@index([wardrobeId])
  @@index([categoryId])
  @@index([season])
  @@index([status])
  @@index([isPrivate])
}

model ClothingImage {
  id        String   @id @default(uuid())
  itemId    String
  url       String
  order     Int      @default(0)
  createdAt DateTime @default(now())

  // Relations
  item      ClothingItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
}

model WardrobeShare {
  id          String    @id @default(uuid())
  wardrobeId  String
  ownerId     String
  sharedWithId String
  permission  SharePermission @default(VIEW_ONLY)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  wardrobe    Wardrobe @relation(fields: [wardrobeId], references: [id], onDelete: Cascade)
  owner       User @relation("WardrobeOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  sharedWith  User @relation("SharedWithUser", fields: [sharedWithId], references: [id], onDelete: Cascade)

  @@unique([wardrobeId, sharedWithId])
  @@index([wardrobeId])
  @@index([sharedWithId])
}

// ==================== OUTFIT MODELS ====================

model Outfit {
  id          String    @id @default(uuid())
  userId      String
  name        String
  description String?
  season      Season?
  occasion    String?
  tags        String[]
  isFavorite  Boolean   @default(false)
  previewImage String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       OutfitItem[]
  calendarEntries OutfitCalendarEntry[]
  suggestions OutfitSuggestion[]
  shares      OutfitShare[]

  @@index([userId])
  @@index([season])
  @@index([isFavorite])
}

model OutfitItem {
  id        String   @id @default(uuid())
  outfitId  String
  itemId    String
  order     Int      @default(0)
  createdAt DateTime @default(now())

  // Relations
  outfit    Outfit @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  item      ClothingItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([outfitId, itemId])
  @@index([outfitId])
  @@index([itemId])
}

model OutfitCalendarEntry {
  id          String    @id @default(uuid())
  outfitId    String
  userId      String
  scheduledDate DateTime
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  outfit      Outfit @relation(fields: [outfitId], references: [id], onDelete: Cascade)

  @@unique([userId, scheduledDate])
  @@index([userId])
  @@index([scheduledDate])
}

model OutfitSuggestion {
  id          String    @id @default(uuid())
  wardrobeId  String
  outfitId    String?
  suggestedById String
  isAccepted  Boolean?  // null = pending, true = accepted, false = rejected
  comment     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  wardrobe    Wardrobe @relation(fields: [wardrobeId], references: [id], onDelete: Cascade)
  outfit      Outfit? @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  suggestedBy User @relation(fields: [suggestedById], references: [id], onDelete: Cascade)

  @@index([wardrobeId])
  @@index([suggestedById])
}

model OutfitShare {
  id          String    @id @default(uuid())
  outfitId    String
  ownerId     String
  sharedWithId String
  permission  SharePermission @default(VIEW_ONLY)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  outfit      Outfit @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  owner       User @relation("OutfitOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  sharedWith  User @relation("SharedWithUser_Outfit", fields: [sharedWithId], references: [id], onDelete: Cascade)

  @@unique([outfitId, sharedWithId])
  @@index([outfitId])
  @@index([sharedWithId])
}

// ==================== STYLIST MARKETPLACE MODELS ====================

model StylingRequest {
  id              String    @id @default(uuid())
  userId          String
  occasion        String
  timeline        RequestTimeline @default(FLEXIBLE)
  requestType     RequestType @default(IMMEDIATE)
  scheduledStartTime DateTime? // For SCHEDULED requests - appointment start
  scheduledEndTime   DateTime? // For SCHEDULED requests - appointment end
  preferredStyles String[]
  budget          Float?
  notes           String?
  status          RequestStatus @default(PENDING)
  matchedStylistId String?
  expiresAt       DateTime? // For IMMEDIATE requests - race mode expiry (5 min)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  session         StylingSession?

  @@index([userId])
  @@index([status])
  @@index([matchedStylistId])
  @@index([requestType])
  @@index([scheduledStartTime])
}

model StylingSession {
  id              String    @id @default(uuid())
  requestId       String    @unique
  userId          String
  stylistId       String
  status          SessionStatus @default(ACTIVE)
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  isFreeSession   Boolean   @default(false)
  amountCharged   Float?
  platformFee     Float?
  stylistEarning  Float?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  request         StylingRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user            User @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)
  stylist         User @relation("StylistSessions", fields: [stylistId], references: [id], onDelete: Cascade)
  messages        Message[]
  review          Review?
  payment         Payment?

  @@index([userId])
  @@index([stylistId])
  @@index([status])
}

model Message {
  id          String    @id @default(uuid())
  sessionId   String
  senderId    String
  content     String
  images      String[]
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())

  // Relations
  session     StylingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sender      User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([senderId])
  @@index([createdAt])
}

model Review {
  id          String    @id @default(uuid())
  sessionId   String    @unique
  userId      String
  stylistId   String
  rating      Int // 1-5
  comment     String?
  isFlagged   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  session     StylingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User @relation("ReviewsFromUser", fields: [userId], references: [id], onDelete: Cascade)
  stylist     User @relation("ReviewsForStylist", fields: [stylistId], references: [id], onDelete: Cascade)

  @@index([stylistId])
  @@index([rating])
}

// ==================== PAYMENT MODELS ====================

model Payment {
  id                String    @id @default(uuid())
  sessionId         String    @unique
  userId            String
  amount            Float
  platformFee       Float
  stylistEarning    Float
  razorpayOrderId   String    @unique
  razorpayPaymentId String?   @unique
  razorpaySignature String?
  status            PaymentStatus @default(PENDING)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  session           StylingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user              User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([razorpayOrderId])
}

model Transaction {
  id              String    @id @default(uuid())
  stylistProfileId String
  type            TransactionType
  amount          Float
  description     String
  balanceBefore   Float
  balanceAfter    Float
  createdAt       DateTime  @default(now())

  // Relations
  stylistProfile  StylistProfile @relation(fields: [stylistProfileId], references: [id], onDelete: Cascade)

  @@index([stylistProfileId])
  @@index([createdAt])
}

model Withdrawal {
  id              String    @id @default(uuid())
  stylistProfileId String
  amount          Float
  bankAccountNumber String
  ifscCode        String
  accountHolderName String
  status          WithdrawalStatus @default(PENDING)
  processedAt     DateTime?
  failureReason   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  stylistProfile  StylistProfile @relation(fields: [stylistProfileId], references: [id], onDelete: Cascade)

  @@index([stylistProfileId])
  @@index([status])
}

// ==================== NOTIFICATION MODELS ====================

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean   @default(false)
  createdAt DateTime  @default(now())

  // Relations
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}
